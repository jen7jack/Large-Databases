---------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/jenniferjackson/Desktop/NYU/Large Databases/PS11/JenniferJackson_PS
> 11.log
  log type:  text
 opened on:  16 May 2019, 14:34:51

. use "LUSD_sub_4_5.dta", clear

. 
. * PROBLEM 1 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~     
>                            
. * (a)
. drop if grade==4
(18,932 observations deleted)

. * MODEL 1
. xtreg mathz age female lep speced immig econdis black hispanic asian i.year mathz_1, 
> fe

Fixed-effects (within) regression               Number of obs     =     18,616
Group variable: teacher                         Number of groups  =        891

R-sq:                                           Obs per group:
     within  = 0.3900                                         min =          1
     between = 0.6378                                         avg =       20.9
     overall = 0.4702                                         max =         49

                                                F(11,17714)       =    1029.70
corr(u_i, Xb)  = 0.1348                         Prob > F          =     0.0000

------------------------------------------------------------------------------
       mathz |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         age |  -.1050293   .0077227   -13.60   0.000    -.1201664   -.0898921
      female |  -.0445529   .0088802    -5.02   0.000     -.061959   -.0271468
         lep |  -.1198073   .0183165    -6.54   0.000    -.1557095   -.0839052
      speced |  -.2882529   .0209567   -13.75   0.000      -.32933   -.2471757
       immig |   .1036697   .0278676     3.72   0.000     .0490464     .158293
     econdis |  -.0556087   .0158474    -3.51   0.000    -.0866711   -.0245464
       black |  -.1946205   .0224231    -8.68   0.000    -.2385721    -.150669
    hispanic |  -.0841331   .0212578    -3.96   0.000    -.1258004   -.0424658
       asian |   .0912324   .0298187     3.06   0.002     .0327848    .1496801
             |
        year |
       2006  |   .1516612   .0107253    14.14   0.000     .1306385    .1726839
             |
     mathz_1 |   .5026987   .0054623    92.03   0.000      .491992    .5134054
       _cons |   1.432146   .0895861    15.99   0.000     1.256548    1.607743
-------------+----------------------------------------------------------------
     sigma_u |  .31949405
     sigma_e |  .58224407
         rho |  .23142146   (fraction of variance due to u_i)
------------------------------------------------------------------------------
F test that all u_i=0: F(890, 17714) = 4.75                  Prob > F = 0.0000

. eststo
(est1 stored)

. * stored as est1
. * For 5th grade, when using a fixed effect for classroom teacher, maths scores
. * are only directly related to immigration status and Asian ethnicity.
. 
. * (b)
. * MODEL 2
. xtreg mathz age female lep speced immig econdis black hispanic asian i.year mathz_1, 
> re

Random-effects GLS regression                   Number of obs     =     18,616
Group variable: teacher                         Number of groups  =        891

R-sq:                                           Obs per group:
     within  = 0.3898                                         min =          1
     between = 0.6414                                         avg =       20.9
     overall = 0.4720                                         max =         49

                                                Wald chi2(11)     =   12852.82
corr(u_i, X)   = 0 (assumed)                    Prob > chi2       =     0.0000

------------------------------------------------------------------------------
       mathz |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         age |  -.1103306     .00765   -14.42   0.000    -.1253243   -.0953369
      female |  -.0434574   .0088284    -4.92   0.000    -.0607608    -.026154
         lep |  -.1441215   .0156531    -9.21   0.000     -.174801    -.113442
      speced |    -.29755   .0206584   -14.40   0.000    -.3380396   -.2570604
       immig |   .1035356   .0274795     3.77   0.000     .0496768    .1573943
     econdis |  -.0724573   .0153028    -4.73   0.000    -.1024502   -.0424644
       black |  -.2154493   .0214189   -10.06   0.000    -.2574296    -.173469
    hispanic |  -.1017272   .0204909    -4.96   0.000    -.1418886   -.0615657
       asian |   .0883698   .0295091     2.99   0.003     .0305331    .1462065
             |
        year |
       2006  |   .1732067   .0099963    17.33   0.000     .1536143    .1927992
             |
     mathz_1 |   .5061056   .0053106    95.30   0.000      .495697    .5165143
       _cons |   1.500119    .088764    16.90   0.000     1.326144    1.674093
-------------+----------------------------------------------------------------
     sigma_u |  .25203629
     sigma_e |  .58224407
         rho |  .15780742   (fraction of variance due to u_i)
------------------------------------------------------------------------------

. eststo
(est2 stored)

. * stored as est2
. * When using a random effect for the classroom teacher, the effects of the
. * covariates are only slighly changed (in both directions - some a bit higher and
. * some a bit lower).
. 
. * (c)
. hausman est1 est2

                 ---- Coefficients ----
             |      (b)          (B)            (b-B)     sqrt(diag(V_b-V_B))
             |      est1         est2        Difference          S.E.
-------------+----------------------------------------------------------------
         age |   -.1050293    -.1103306        .0053013        .0010571
      female |   -.0445529    -.0434574       -.0010955        .0009577
         lep |   -.1198073    -.1441215        .0243142        .0095118
      speced |   -.2882529      -.29755        .0092971        .0035235
       immig |    .1036697     .1035356        .0001341        .0046352
     econdis |   -.0556087    -.0724573        .0168486        .0041187
       black |   -.1946205    -.2154493        .0208288        .0066352
    hispanic |   -.0841331    -.1017272        .0175941        .0056581
       asian |    .0912324     .0883698        .0028626        .0042863
        year |
       2006  |    .1516612     .1732067       -.0215455        .0038866
     mathz_1 |    .5026987     .5061056       -.0034069        .0012784
------------------------------------------------------------------------------
                           b = consistent under Ho and Ha; obtained from xtreg
            B = inconsistent under Ha, efficient under Ho; obtained from xtreg

    Test:  Ho:  difference in coefficients not systematic

                 chi2(11) = (b-B)'[(V_b-V_B)^(-1)](b-B)
                          =       90.79
                Prob>chi2 =      0.0000

. * The p-value for this test is 0, meaning that we reject the null hypothesis.
. * I.e., we do have reason to believe there is a systematic difference in
. * coefficients between these two models. Because the Chi-Squared statistic is
. * statistically significant, we should not use the random effects model.
. 
. * PROBLEM 2 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~     
>                            
. 
. use "LUSD_sub_4_5.dta", clear

. * Can only use students who have both 4th grade and 5th grade data (6,247 students)
. duplicates tag id, generate (dupe)

Duplicates in terms of id

. drop if dupe == 0
(25,329 observations deleted)

. 
. * (a)
. gen same_race = 0

. replace same_race = 1 if tch_black == 1 & black == 1 & year == 2005
(1,077 real changes made)

. * 1,077 black teacher/student matches in 2005
. replace same_race = 1 if tch_black == 1 & black == 1 & year == 2006
(1,169 real changes made)

. * 1,169 black teacher/student matches in 2006
. 
. replace same_race = 1 if tch_hisp == 1 & hispanic == 1 & year == 2005
(1,903 real changes made)

. * 1,903 Hispanic teacher/student matches in 2005
. replace same_race = 1 if tch_hisp == 1 & hispanic == 1 & year == 2006
(1,313 real changes made)

. * 1,313 Hispanic teacher/student matches in 2006
. 
. replace same_race = 1 if tch_asian == 1 & asian == 1 & year == 2005
(14 real changes made)

. * 14 Asian teacher/student matches in 2005
. replace same_race = 1 if tch_asian == 1 & asian == 1 & year == 2006
(6 real changes made)

. * 6 Asian teacher/student matches in 2006
. 
. replace same_race = 1 if tch_white == 1 & white == 1 & year == 2005
(470 real changes made)

. * 470 white teacher/student matches
. replace same_race = 1 if tch_white == 1 & white == 1 & year == 2006
(456 real changes made)

. * 456 white teacher/student matches
. 
. * In 2005, there were 6,247 student observations and 3,464 of those were
. * same-race matches between teachers and students. That is a 55% match rate
. * for 2005.
. 
. * In 2006, of the 6,247 student observations, 2,944 were same-race matches
. * between teachers and students. That is a 47% match rate for 2006.
. 
. * (b)
. * MODEL 3
. xtset id year
       panel variable:  id (strongly balanced)
        time variable:  year, 2005 to 2006
                delta:  1 unit

. xtreg mathz age female lep speced immig econdis black hispanic asian i.year mathz_1 s
> ame_race, fe

Fixed-effects (within) regression               Number of obs     =     12,362
Group variable: id                              Number of groups  =      6,215

R-sq:                                           Obs per group:
     within  = 0.2488                                         min =          1
     between = 0.6825                                         avg =        2.0
     overall = 0.3709                                         max =          2

                                                F(12,6135)        =     169.31
corr(u_i, Xb)  = -0.8656                        Prob > F          =     0.0000

------------------------------------------------------------------------------
       mathz |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         age |   .0026342   .1821397     0.01   0.988    -.3544234    .3596919
      female |  -.0261046   .2599713    -0.10   0.920    -.5357395    .4835304
         lep |    .128452   .0275891     4.66   0.000     .0743677    .1825364
      speced |  -.0758908   .0630638    -1.20   0.229    -.1995179    .0477363
       immig |   .0484866    .061245     0.79   0.429    -.0715751    .1685482
     econdis |   .0007773   .0363737     0.02   0.983    -.0705279    .0720825
       black |   .5874868   .5868628     1.00   0.317    -.5629701    1.737944
    hispanic |   .3165368   .4931375     0.64   0.521    -.6501857    1.283259
       asian |  -.2072758   .4932704    -0.42   0.674    -1.174259    .7597072
             |
        year |
       2006  |   .1529834    .182365     0.84   0.402    -.2045159    .5104828
             |
     mathz_1 |   -.408945   .0099915   -40.93   0.000    -.4285318   -.3893583
   same_race |    .034013   .0158735     2.14   0.032     .0028954    .0651307
       _cons |  -.1532087   1.919861    -0.08   0.936    -3.916809    3.610391
-------------+----------------------------------------------------------------
     sigma_u |   1.156141
     sigma_e |  .45003051
         rho |  .86841941   (fraction of variance due to u_i)
------------------------------------------------------------------------------
F test that all u_i=0: F(6214, 6135) = 2.77                  Prob > F = 0.0000

. eststo
(est3 stored)

. * stored as est3
. * The coefficient of "same_race" is 0.03 and is statistically significant. This
. * means that a student paired with a teacher of the same race will see a slight
. * increase in maths scores (about 3 points on average).
. 
. * (c)
. xttrans same_race

           |       same_race
 same_race |         0          1 |     Total
-----------+----------------------+----------
         0 |     78.01      21.99 |    100.00 
         1 |     32.68      67.32 |    100.00 
-----------+----------------------+----------
     Total |     52.87      47.13 |    100.00 

. * Of the 47.13% of students ever matched with teachers of the same race, 67.32%
. * of those students stayed matched from 4th grade to 5th grade.
. 
. * PROBLEM 3 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~     
>                            
. 
. use "math_BMI_sub.dta", clear

. 
. * (a) Reshape data.
. 
. * Time-varying variables:
. rename C1R3MSCL cr3mscl1

. rename C2R3MSCL cr3mscl2

. rename C3R3MSCL cr3mscl3

. rename C4R3MSCL cr3mscl4

. rename C5R3MSCL cr3mscl5

. rename C6R3MSCL cr3mscl6

. rename C1BMI cbmi1

. rename C2BMI cbmi2

. rename C3BMI cbmi3

. rename C4BMI cbmi4

. rename C5BMI cbmi5

. rename C6BMI cbmi6

. 
. reshape long cr3mscl cbmi, i(CHILDID GENDER RACE R3SAMPLE FKCHGSCH R4R2SCHG ///
> R5R4SCHG R6R5SCHG P1FIRKDG T6GLVL) j(when) string
(note: j = 1 2 3 4 5 6)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                    13989   ->   83934
Number of variables                  25   ->      16
j variable (6 values)                     ->   when
xij variables:
         cr3mscl1 cr3mscl2 ... cr3mscl6   ->   cr3mscl
                  cbmi1 cbmi2 ... cbmi6   ->   cbmi
-----------------------------------------------------------------------------

. * "when" takes on the values 1 through 6
. 
. * (b)
. drop if cbmi==.
(19,933 observations deleted)

. drop if cbmi <0
(1,789 observations deleted)

. drop if cr3mscl==.
(6 observations deleted)

. 
. * Model 1
. regress cr3mscl cbmi

      Source |       SS           df       MS      Number of obs   =    62,206
-------------+----------------------------------   F(1, 62204)     =   8257.50
       Model |  9732418.88         1  9732418.88   Prob > F        =    0.0000
    Residual |  73314634.4    62,204  1178.61608   R-squared       =    0.1172
-------------+----------------------------------   Adj R-squared   =    0.1172
       Total |  83047053.3    62,205  1335.05431   Root MSE        =    34.331

------------------------------------------------------------------------------
     cr3mscl |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        cbmi |    3.57105   .0392981    90.87   0.000     3.494026    3.648074
       _cons |  -4.418068   .7005402    -6.31   0.000    -5.791128   -3.045008
------------------------------------------------------------------------------

. eststo
(est4 stored)

. * stored as est4
. 
. * Model 2
. destring when, generate(time)
when: all characters numeric; time generated as byte

. regress cr3mscl cbmi i.time

      Source |       SS           df       MS      Number of obs   =    62,206
-------------+----------------------------------   F(6, 62199)     =  40941.37
       Model |    66267808         6  11044634.7   Prob > F        =    0.0000
    Residual |  16779245.3    62,199  269.767124   R-squared       =    0.7980
-------------+----------------------------------   Adj R-squared   =    0.7979
       Total |  83047053.3    62,205  1335.05431   Root MSE        =    16.425

------------------------------------------------------------------------------
     cr3mscl |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        cbmi |  -.3519483   .0208285   -16.90   0.000    -.3927721   -.3111245
             |
        time |
          2  |   10.52566   .2036541    51.68   0.000      10.1265    10.92483
          3  |   17.19712   .2975413    57.80   0.000     16.61394     17.7803
          4  |   35.25735   .2084834   169.11   0.000     34.84872    35.66598
          5  |   70.58066   .2204661   320.14   0.000     70.14854    71.01277
          6  |    93.0701   .2451809   379.60   0.000     92.58955    93.55066
             |
       _cons |   28.13589   .3693147    76.18   0.000     27.41203    28.85974
------------------------------------------------------------------------------

. eststo
(est5 stored)

. * stored as est5
. 
. * (c)
. * Model 3
. xtset time
       panel variable:  time (unbalanced)

. xtreg cr3mscl cbmi, fe

Fixed-effects (within) regression               Number of obs     =     62,206
Group variable: time                            Number of groups  =          6

R-sq:                                           Obs per group:
     within  = 0.0046                                         min =      4,026
     between = 0.9356                                         avg =   10,367.7
     overall = 0.1172                                         max =     13,496

                                                F(1,62199)        =     285.52
corr(u_i, Xb)  = -0.4147                        Prob > F          =     0.0000

------------------------------------------------------------------------------
     cr3mscl |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        cbmi |  -.3519483   .0208285   -16.90   0.000    -.3927721   -.3111245
       _cons |   64.15124   .3699647   173.40   0.000     63.42611    64.87637
-------------+----------------------------------------------------------------
     sigma_u |  36.696115
     sigma_e |  16.424589
         rho |  .83310332   (fraction of variance due to u_i)
------------------------------------------------------------------------------
F test that all u_i=0: F(5, 62199) = 41914.22                Prob > F = 0.0000

. * By making time the fixed effect, we're looking at the effect of maths scores
. * on bmi for each time interval.
. eststo
(est6 stored)

. * stored as est6
. 
. * (d)
. estimates table est4 est5 est6

-----------------------------------------------------
    Variable |    est4         est5         est6     
-------------+---------------------------------------
        cbmi |    3.57105   -.35194829   -.35194829  
             |
        time |
          2  |               10.525664               
          3  |               17.197119               
          4  |               35.257352               
          5  |               70.580656               
          6  |               93.070104               
             |
       _cons | -4.4180679    28.135886    64.151239  
-----------------------------------------------------

. * Model 1, a simple OLS regression, gives a positive coefficient of 3.57, but
. * when taking into account that this is panel data, Models 2 and 3 both give the
. * same negative coefficient: -0.35. This can be interpreted as, for every one
. * unit increase in BMI, on average, there is a -0.35 point decrease in maths
. * scores.
. 
. log close
      name:  <unnamed>
       log:  /Users/jenniferjackson/Desktop/NYU/Large Databases/PS11/JenniferJackson_PS
> 11.log
  log type:  text
 closed on:  16 May 2019, 14:34:55
---------------------------------------------------------------------------------------
